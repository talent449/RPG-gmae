<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¥³å­©çš„é—–é—œå†’éšª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        body { margin: 0; overflow: hidden; background: #222; font-family: 'DotGothic16', sans-serif; touch-action: none;
        }

        /* === éŠæˆ²ä¸»ç•«é¢ === */
        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            overflow: hidden; transition: background 0.5s;
            display: none; /* åˆå§‹éš±è—ï¼Œç›´åˆ°é¸æ“‡è§’è‰² */
        }

        /* === è§’è‰²é¸æ“‡ä»‹é¢æ¨£å¼ === */
        #role-select-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #222;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
        }
        .role-btn {
            background: #4caf50;
            color: white;
            border: 4px solid #fff;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s, background 0.2s;
        }
        .role-btn:hover {
            background: #388e3c;
            transform: scale(1.05);
        }

        /* === ä¸»è§’æ¨£å¼ (ç•¥) === */
        #player {
            position: absolute;
            width: 10%; height: 10%;
            z-index: 10;
            transition: all 0.1s ease-out;
            background-image: url('me.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom; 
            font-size: 0;
        }
        #player.walking {
            transform: translateY(-5px);
        }

        /* === ç‰©ä»¶æ¨£å¼ (ç•¥) === */
        .obj {
            position: absolute;
            display: flex; justify-content: center; align-items: flex-end;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            transition: all 0.3s;
        }

        .obj-sprite {
            width: 50px; 
            height: 50px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom; 
            font-size: 0; 
        }
        .quest-box {
            cursor: pointer;
        }

        .obj-locked { 
            filter: grayscale(100%) opacity(50%) drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            cursor: not-allowed; 
        }

        .sprite-dark-box { 
            background-image: url('dark-box.png');
            width: 70px; 
            height: 70px;
        }
        .sprite-green-box { 
            background-image: url('green-box.png');
            width: 70px; 
            height: 70px;
        }
        .sprite-red-box { 
            background-image: url('red-box.png');
            width: 70px; 
            height: 70px;
        }
        
        .sprite-ghost {
            background-image: url('ghost.png');
            width: 60px;
            height: 60px;
            animation: float 4s ease-in-out infinite; 
        }
        .sprite-gold-box { 
            background-image: url('gold-box.png');
            width: 70px;
            height: 70px;
        }
        .sprite-key { 
            font-size: 60px; 
            text-shadow: 0 0 5px #000, 0 0 10px rgba(0,0,0,0.5); 
            animation: float 6s ease-in-out infinite;
        }

        .sprite-bghost {
            background-image: url('bghost.png');
            width: 65px;
            height: 65px;
            animation: float 4s ease-in-out infinite; 
        }
        .sprite-spider {
            background-image: url('spider.png');
            width: 55px;
            height: 55px;
            animation: float 5s ease-in-out infinite reverse; 
        }
        .sprite-head {
            background-image: url('head.png');
            width: 60px;
            height: 60px;
	    animation: float 5s ease-in-out infinite reverse;
        }
        .sprite-princess { 
            background-image: url('princess.png');
            width: 80px;
            height: 100px;
            background-size: contain;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0.8; }
            50% { transform: translate(0, -15px) rotate(1deg); opacity: 1; }
            100% { transform: translate(0, 0) rotate(0deg); opacity: 0.8; }
        }
        @keyframes swing {
            0% { transform: rotate(-5deg); }
            100% { transform: rotate(5deg); }
        }


        /* === å°è©±æ¡†æ¨£å¼ (ç•¥) === */
        #dialog-box {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px;
            padding: 20px; background: white; border: 5px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 100;
            display: none;
        }
        #dialog-title { font-size: 1.5em;
            margin-bottom: 10px; color: #d32f2f; }
        #dialog-content { margin-bottom: 15px;
        }
        #ans-input { width: calc(100% - 100px); padding: 5px; font-family: inherit; font-size: 1em;
            border: 2px solid #ccc;}
        #ans-input:focus { border-color: #333; outline: none;
        }
        #submit-btn, #dialog-msg-only { 
            padding: 5px 10px;
            background: #4caf50; color: white; border: none; cursor: pointer; margin-left: 5px;
            font-family: inherit;
        }
        #submit-btn:hover, #dialog-msg-only:hover { background: #388e3c;
        }

        /* === è³‡è¨Šæ¬„ä½ (ç•¥) === */
        #info-bar { position: fixed;
            top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; z-index: 50; border-radius: 5px;
        }
        /* âœ¨ ä¿®æ­£ï¼šåˆå§‹éš±è—æ§åˆ¶æŒ‰éˆ•ï¼Œé¿å…è¦†è“‹è§’è‰²é¸æ“‡ç•«é¢ âœ¨ */
        #controls { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            z-index: 50; 
        }
        .control-btn { width: 50px; height: 50px; background: rgba(0,0,0,0.5); color: white;
            border: none; margin: 2px; font-size: 20px; cursor: pointer; }
        .control-btn:active { background: rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <div id="role-select-screen">
        <h2>é¸æ“‡ä¸€ä½æŒ‘æˆ°è€…</h2>
        <button class="role-btn" onclick="startGame('hard')">
            Sherry (äºŒå¹´ç´š): ç¶œåˆé›£åº¦
        </button>
        <button class="role-btn" onclick="startGame('easy')">
            Jennie (5æ­²): å¹¼å…’é›£åº¦
        </button>
        <p style="margin-top: 30px;">(é»æ“Šå¾Œè«‹å‹™å¿…å†æ¬¡é»æ“Šæ–¹å‘éµä»¥é–‹å•ŸèƒŒæ™¯éŸ³æ¨‚)</p>
    </div>

    <div id="game-container">
        <div id="map-objects"></div>
        <div id="player"></div>
    </div>

    <div id="info-bar">
        <div id="map-name">ç¥å¥‡æ£®æ— (ç¬¬1é—œ)</div>
        <div>åˆ†æ•¸: <span id="score">0/9</span></div>
    </div>

    <div id="dialog-box">
        <div id="dialog-title"></div>
        <div id="dialog-content"></div>
        <div id="dialog-input-area">
            <input type="text" id="ans-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ">
            <button id="submit-btn" onclick="checkAnswer()">ç¢ºèª</button>
        </div>
        <button id="dialog-msg-only" style="display: none;">é—œé–‰/ç¢ºèª</button>
    </div>

    <div id="controls">
        <button class="control-btn" onmousedown="move('up')" ontouchstart="move('up')" onmouseup="stop()" ontouchend="stop()">â†‘</button>
        <div>
            <button class="control-btn" onmousedown="move('left')" ontouchstart="move('left')" onmouseup="stop()" ontouchend="stop()">â†</button>
            <button 
                class="control-btn" onmousedown="move('right')" ontouchstart="move('right')" onmouseup="stop()" ontouchend="stop()">â†’</button>
        </div>
        <button class="control-btn" onmousedown="move('down')" ontouchstart="move('down')" onmouseup="stop()" ontouchend="stop()">â†“</button>
    </div>

    <audio id="bgm-player" src="bg music.mp3" autoplay loop muted></audio>
    
    <audio id="sfx-correct" src="correct.mp3"></audio>
    <audio id="sfx-wrong" src="wrong.mp3"></audio>
    <audio id="bgm-mapC" src="bg3 music.mp3" loop muted></audio>

    <script>
        /* ================= é¡Œåº«å€ (ä¸è®Š) ================= */

        function selectRandom(array, count) {
            const shuffled = array.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        const rawQuestions = {
            easy_math: [
                {q: "2 + 3 = ?", a: "5"},
                {q: "7 - 4 = ?", a: "3"},
                {q: "1 + 6 = ?", a: "7"},
                {q: "9 - 2 = ?", a: "7"},
                {q: "5 + 5 = ?", a: "10"}
            ],
            easy_abc: [
                {q: "å­—æ¯è¡¨ä¸Šï¼ŒA å¾Œé¢æ˜¯å“ªå€‹å­—æ¯ï¼Ÿ", a: "B"},
                {q: "apple é€™å€‹å–®å­—çš„ç¬¬ä¸€å€‹å­—æ¯æ˜¯ï¼Ÿ", a: "A"},
                {q: "cat é€™å€‹å–®å­—æœ‰å¹¾å€‹å­—æ¯ï¼Ÿ", a: "3"},
                {q: "Z å‰é¢çš„å­—æ¯æ˜¯ï¼Ÿ", a: "Y"}
            ],
            easy_color: [
                {q: "å¤©ç©ºæ˜¯ä»€éº¼é¡è‰²ï¼Ÿ(ä¸­æ–‡)", a: "è—"},
                {q: "è«‹è¼¸å…¥ RED çš„ä¸­æ–‡é¡è‰²ã€‚", a: "ç´…"},
                {q: "é¦™è•‰æ˜¯ä»€éº¼é¡è‰²ï¼Ÿ(ä¸­æ–‡)", a: "é»ƒ"},
                {q: "è«‹è¼¸å…¥ YELLOW çš„ä¸­æ–‡é¡è‰²ã€‚", a: "é»ƒ"}
            ],
            hard_math: [
                {q: "åª½åª½çƒ¤äº† 35 å€‹é¤…ä¹¾ï¼Œåˆ†çµ¦å°æ˜å’Œä»– 4 å€‹æœ‹å‹ï¼Œæ¯äººèƒ½åˆ†åˆ°å¹¾å€‹ï¼Ÿ", a: "7"},
                {q: "å¦¹å¦¹æœ‰ 150 å…ƒï¼Œè²·äº†ä¸€æ 75 å…ƒçš„é‹¼ç­†å’Œä¸€æœ¬ 25 å…ƒçš„ç­†è¨˜æœ¬ï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ", a: "50"},
                {q: "ä¸€ç›’é›è›‹æœ‰ 10 é¡†ï¼Œè²· 5 ç›’ï¼Œç…®æ‰ 8 é¡†ï¼Œé‚„å‰©ä¸‹å¹¾é¡†ï¼Ÿ", a: "42"},
                {q: "ä¸€è¼›å…¬è»Šä¸ŠåŸä¾†æœ‰ 12 äººï¼Œä¸Šè»Š 9 äººï¼Œä¸‹è»Š 4 äººï¼Œç¾åœ¨è»Šä¸Šæœ‰å¹¾äººï¼Ÿ", a: "17"},
                {q: "å°è¯æœ‰ 48 å¼µè²¼ç´™ï¼Œåˆ†çµ¦ 3 ä½åŒå­¸ï¼Œä»–è‡ªå·±ä¹Ÿæ‹¿ä¸€ä»½ï¼Œæ¯äººåˆ†åˆ°å¹¾å¼µï¼Ÿ", a: "12"} 
            ],
            hard_eng_possessive: [
                {q: "This book is (I/mine).", a: "mine"},
                {q: "___ pencil is this? It's Lucy's. (Who/Whose)", a: "Whose"},
                {q: "The dog is (he/his) pet.", a: "his"},
                {q: "The cat is (she/hers).", a: "hers"},
                {q: "That house is (they/theirs).", a: "theirs"}
            ],
            hard_eng_vocabulary: [
                {q: "Please give me the ___. I need to measure the table. (Ruler/Rubber)", a: "Ruler"},
                {q: "I need to stick the paper. Where is the ___? (Paint/Glue stick)", a: "Glue stick"},
                {q: "My hobby is to ___ the beautiful flowers. (Take pictures/Wash clothes)", a: "Take pictures"},
                {q: "I like to ___ big castles in my notebook. (Draw/Eat)", a: "Draw"},
                {q: "Every night, I will ___ before going to bed. (Take a bath/Play games)", a: "Take a bath"}
            ],
            hard_family_math: [
                {q: "åª½åª½æœ‰ä¸‰å€‹å…„å¼Ÿå§Šå¦¹ï¼Œæ‰€ä»¥ä½ æœ‰å¹¾å€‹é˜¿å§¨å’Œå”å”ï¼Ÿ(ä¸åŒ…å«å§‘å§‘)", a: "3"},
                {q: "æˆ‘æœ‰å…©å€‹è¡¨å§ã€ä¸€å€‹å ‚å¼Ÿå’Œä¸€å€‹è¡¨å¦¹ï¼Œæˆ‘æœ‰å¹¾å€‹è¡¨å…„å¼Ÿå§Šå¦¹ï¼Ÿ", a: "4"},
                {q: "çˆºçˆºæœ‰ 4 å€‹å…’å­ï¼Œæ¯å€‹å…’å­æœ‰ 2 å€‹å­©å­ï¼Œç¸½å…±æœ‰å¹¾å€‹å­«å­ï¼Ÿ", a: "8"} 
            ],
            hard_chi_homophone: [
                {q: "å¤©ç©ºè¬é‡Œç„¡é›²ï¼Œæ˜¯å€‹å¤§ï¼ˆç› / æ™´ / æƒ…ï¼‰å¤©ã€‚", a: "æ™´"},
                {q: "é€™ä»¶è¡£æœå¾ˆï¼ˆè¼• / æ™´ / æ¸…ï¼‰ï¼Œä¸€é»éƒ½ä¸é‡ã€‚", a: "è¼•"},
                {q: "è«‹ä½ æŠŠï¼ˆé’ / æ¸… / è¼•ï¼‰æ½”éšŠçš„åˆ¶æœç©¿å¥½ã€‚", a: "æ¸…"},
                {q: "çˆ¸çˆ¸çš„å…¬äº‹ ï¼ˆè¢‹ / å¸¶ï¼‰ è£¡è£è‘—é‡è¦çš„æ–‡ä»¶ã€‚", a: "è¢‹"},
                {q: "ä»–å¹«äº†æˆ‘ï¼Œæˆ‘æ‡‰è©²å‘ä»–ï¼ˆåˆ° / é“ï¼‰è¬ã€‚", a: "é“"},
		{q: "å°æ˜æ­£åœ¨ç­‰ï¼ˆå¾Œ / å€™ï¼‰å…¬è»Šä¾†ã€‚", a: "å€™"},
		{q: "ï¼ˆè¿‘ / é€²ï¼‰æœŸå¾ˆå¤šå°èŸ²åœ¨äº‚é£›ï¼Œå¤§å®¶è¦å°å¿ƒã€‚", a: "è¿‘"}

            ]
        };

        let randomizedQuestions = {};
        let totalQuestionCount = 9; 

        function generateQuestions(difficulty) {
            randomizedQuestions = {};
            
            if (difficulty === 'easy') {
                const easyQs = [
                    ...selectRandom(rawQuestions.easy_math, 3), 
                    ...selectRandom(rawQuestions.easy_abc, 3),
                    ...selectRandom(rawQuestions.easy_color, 3) 
                ];
                
                easyQs.forEach((q, index) => {
                    randomizedQuestions[index + 1] = q; 
                });

                randomizedQuestions[11] = {q: "æ‰¾åˆ°é€šå¾€åŸå ¡çš„é‘°åŒ™äº†ï¼(å‰å¾€ä¸‹ä¸€é—œ)", a: "ok", type: "key", nextMap: "B", req: [1, 2, 3]};
                randomizedQuestions[12] = {q: "é€™æ˜¯é€šå¾€ä¸‹ä¸€é—œçš„é‡‘è‰²å¯¶ç®±ï¼(å‰å¾€ä¸‹ä¸€é—œ)", a: "ok", type: "key", nextMap: "C", req: [4, 5, 6]};
                randomizedQuestions[10] = {q: "æ­å–œé€šé—œï¼å…¬ä¸»åœ¨ç­‰è‘—ä½ ï¼(è¼¸å…¥ ok)", a: "ok", type: "end", req: [7, 8, 9]};

            } else { 
                const mapA_Qs = selectRandom(rawQuestions.hard_math, 3);
                mapA_Qs.forEach((q, index) => {
                    randomizedQuestions[index + 1] = q; 
                });
                randomizedQuestions[11] = {q: "æ‰¾åˆ°é€šå¾€åŸå ¡çš„é‘°åŒ™äº†ï¼(å‰å¾€ä¸‹ä¸€é—œ)", a: "ok", type: "key", nextMap: "B", req: [1, 2, 3]};

                const mapB_Qs = [
                    ...selectRandom(rawQuestions.hard_eng_possessive, 2),
                    ...selectRandom(rawQuestions.hard_family_math, 1)
                ];
                mapB_Qs.forEach((q, index) => {
                    randomizedQuestions[index + 4] = q; 
                });
                randomizedQuestions[12] = {q: "é€™æ˜¯é€šå¾€ä¸‹ä¸€é—œçš„é‡‘è‰²å¯¶ç®±ï¼(å‰å¾€ä¸‹ä¸€é—œ)", a: "ok", type: "key", nextMap: "C", req: [4, 5, 6]};
                
                const mapC_Qs = [
                    ...selectRandom(rawQuestions.hard_chi_homophone, 2),
                    ...selectRandom(rawQuestions.hard_eng_vocabulary, 1)
                ];
                mapC_Qs.forEach((q, index) => {
                    randomizedQuestions[index + 7] = q; 
                });
                randomizedQuestions[10] = {q: "æ­å–œé€šé—œï¼åª½åª½ç”Ÿæ—¥æ˜¯ï¼Ÿ(mmdd)", a: "1206", type: "end", req: [7, 8, 9]};
            }
            
            document.getElementById('score').innerText = solvedIds.length + "/" + totalQuestionCount;
        }

        /* ================= éŠæˆ²å•Ÿå‹•å‡½å¼ (å·²ä¿®æ­£) ================= */

        function startGame(difficulty) {
            // éš±è—é¸æ“‡ä»‹é¢
            document.getElementById('role-select-screen').style.display = 'none';
            // é¡¯ç¤ºéŠæˆ²å®¹å™¨
            document.getElementById('game-container').style.display = 'block';
            // âœ¨ ä¿®æ­£ï¼šé¡¯ç¤ºæ§åˆ¶æŒ‰éˆ• âœ¨
            document.getElementById('controls').style.display = 'flex';

            // 1. ç”Ÿæˆé¡Œç›®
            generateQuestions(difficulty);

            // 2. é–‹å§‹éŠæˆ²
            loadMap("A"); 
            startGameLoop(); 
        }


        /* ================= åœ°åœ–å’Œç‰©ä»¶é…ç½® (ä¸è®Š) ================= */

        const maps = {
            A: {
                name: "ç¥å¥‡æ£®æ— (ç¬¬1é—œ)",
                bg: "#66bb6a",
                bgPattern: "url('map_background_A.png') no-repeat center center / contain",
                objects: [
                    {id: 1, icon: "â“", qType: "dark-box", x: 25, y: 70}, 
                    {id: 2, icon: "â“", qType: "green-box", x: 80, y: 40}, 
                    {id: 3, icon: "â“", qType: "red-box", x: 50, y: 20},
                    {id: 11, icon: "ğŸ—ï¸", x: 80, y: 20, type: "key", nextMap: "B", req: [1, 2, 3]},
                    {type: "dec", icon: "ğŸŒ²", x: 10, y: 10}, 
                    {type: "dec", icon: "ğŸ¡", x: 50, y: 10}, 
                    {type: "dec", icon: "ğŸŒ²", x: 90, y: 80}
                ],
                start: { x: 35, y: 80 } 
            },
            
            B: {
                name: "è‹±æ–‡åŸå ¡ (ç¬¬2é—œ)",
                bg: "#5d4037",
                bgPattern: "url('map_background_B.png') no-repeat center center / cover",
                objects: [
                    {id: 4, icon: "â“", qType: "ghost", x: 30, y: 40}, 
                    {id: 5, icon: "â“", qType: "ghost", x: 70, y: 40}, 
                    {id: 6, icon: "â“", qType: "ghost", x: 20, y: 70}, 
                    {id: 12, icon: "ğŸ”‘", qType: "gold-box", x: 50, y: 10, type: "key", nextMap: "C", req: [4, 5, 6]},
                    
                    {type: "dec", icon: "ğŸ•¯ï¸", x: 20, y: 20}, {type: "dec", icon: "ğŸ•¯ï¸", x: 80, y: 20}, {type: "dec", icon: "ğŸ°", x: 50, y: 50, scale: 2}
                ],
                start: { x: 50, y: 90 }
            },
            
            C: {
                name: "ææ€–æ£®æ— (æœ€çµ‚é—œ)",
                bg: "#3e2723", 
                bgPattern: "url('map_background_C.png') no-repeat center center / cover",
                objects: [
                    {id: 7, icon: "â“", qType: "bghost", x: 10, y: 15}, 
                    {id: 8, icon: "â“", qType: "spider", x: 40, y: 50}, 
                    {id: 9, icon: "â“", qType: "head", x: 80, y: 80}, 
                    {id: 10, icon: "â“", qType: "gold-box", x: 50, y: 20, type: "end", req: [7, 8, 9]}, 
                    
                    {type: "dec", icon: "ğŸ•¸ï¸", x: 10, y: 10}, 
                    {type: "dec", icon: "ğŸ¦‡", x: 90, y: 90}
                ],
                start: { x: 50, y: 90 }
            }
        };

        /* ================= æ ¸å¿ƒç¨‹å¼ (ä¸è®Š) ================= */
        
        let player = { x: 50, y: 90, speed: 1.5, el: document.getElementById('player') };
        let keys = {};
        let currentMapKey = "A";
        let moveDirection = null;
        let gameLoop;
        let solvedIds = [];
        let activeObj = null;

        // éµç›¤ç›£è½... 
        window.addEventListener('keydown', e => { 
            keys[e.key] = true;
            unmuteBGM(); 
        });
        window.addEventListener('keyup', e => { keys[e.key] = false; });

        function playBGM(mapKey) {
            const bgm1 = document.getElementById('bgm-player');
            const bgm3 = document.getElementById('bgm-mapC');
            
            [bgm1, bgm3].forEach(bgm => {
                if(bgm) {
                    bgm.pause();
                    bgm.currentTime = 0;
                    if(bgm.id === 'bgm-mapC' && mapKey !== 'C') bgm.muted = true;
                    if(bgm.id === 'bgm-player' && mapKey === 'C') bgm.muted = true;
                }
            });
            
            let targetBGM = (mapKey === 'C' && bgm3) ? bgm3 : bgm1;
            
            if (targetBGM && !targetBGM.muted) {
                targetBGM.play().catch(e => { console.log("BGM æ’­æ”¾å¤±æ•—ï¼š", e); });
            }
        }
        
        function unmuteBGM() {
            const bgm1 = document.getElementById('bgm-player');
            const bgm3 = document.getElementById('bgm-mapC');
            
            let currentBGM = (currentMapKey === 'C' && bgm3) ? bgm3 : bgm1;
            
            if (currentBGM && currentBGM.muted) {
                currentBGM.muted = false; 
                currentBGM.play().catch(e => { console.log("BGM æ’­æ”¾å¤±æ•—ï¼š", e); });
                
                document.getElementById('controls').removeEventListener('touchstart', unmuteBGM, { once: true });
                document.getElementById('controls').removeEventListener('mousedown', unmuteBGM, { once: true });
            }
        }
        
        document.getElementById('controls').addEventListener('touchstart', unmuteBGM, { once: true });
        document.getElementById('controls').addEventListener('mousedown', unmuteBGM, { once: true });

        function startGameLoop() {
            clearInterval(gameLoop);
            gameLoop = setInterval(() => {
                if(document.getElementById('dialog-box').style.display === 'block') return;

                let dx = 0; let dy = 0;
                
                if (keys['ArrowUp'] || moveDirection === 'up') dy = -1;
            
                if (keys['ArrowDown'] || moveDirection === 'down') dy = 1;
                if (keys['ArrowLeft'] || moveDirection === 'left') dx = -1;
                if (keys['ArrowRight'] || moveDirection === 'right') dx = 1;

                if (dx !== 0 || dy !== 0) {
                
                    player.x += dx * player.speed * 0.4;
                    player.y += dy * player.speed * 0.4;
                    
                    if(player.x < 2) player.x = 2; if(player.x > 95) player.x = 95;
             
                    if(player.y < 5) player.y = 5; if(player.y > 95) player.y = 95;

                    player.el.style.left = player.x + "%";
                    player.el.style.top = player.y + "%";
                    player.el.classList.add('walking');
                    checkCollision(); 
                } else {
                    player.el.classList.remove('walking');
                }
            }, 20);
        }

        function loadMap(mapKey) {
            currentMapKey = mapKey;
            const map = maps[mapKey];
            const container = document.getElementById('game-container');
            const objContainer = document.getElementById('map-objects');
            
            container.style.backgroundColor = map.bg;
            container.style.background = map.bgPattern;
            document.getElementById('map-name').innerText = map.name;

            playBGM(mapKey);

            objContainer.innerHTML = '';
            map.objects.forEach(obj => {
                let isSolved = solvedIds.includes(obj.id);
                
                if(obj.id && isSolved && obj.type !== 'end') return; 

                let el = document.createElement('div');
                el.className = 'obj obj-sprite ' + (obj.type === 'dec' ? '' : 'quest-box');
     
           
                if (obj.qType) {
                    el.classList.add(`sprite-${obj.qType}`);
                } 
                else if (obj.icon === "ğŸ—ï¸") {
                     el.classList.add('sprite-key');
                }

                if (obj.id === 10 && isSolved) {
                    el.classList.remove(`sprite-${obj.qType}`); 
                    el.classList.add('sprite-princess'); 
                    el.classList.remove('quest-box'); 
                    el.dataset.id = obj.id;
                    el.id = `obj-${obj.id}`;
                    el.innerText = ""; 
                } else {
                    el.innerText = obj.icon;
                }
       
          
                el.style.left = obj.x + "%";
                el.style.top = obj.y + "%";
                if(obj.scale) el.style.transform = `scale(${obj.scale})`;
                
                if(obj.id) {
                  
                    el.dataset.id = obj.id;
                    el.id = `obj-${obj.id}`;
                    if(isLocked(obj.id)) {
                        el.classList.add('obj-locked');
                    }
                }
                objContainer.appendChild(el);
            });
            
            player.x = map.start.x;
            player.y = map.start.y;
            
            player.el.style.left = player.x + "%";
            player.el.style.top = player.y + "%";
        }

        function isLocked(id) {
            const q = randomizedQuestions[id]; 
            if (!q || !q.req) return false;
            return !q.req.every(reqId => solvedIds.includes(reqId));
        }

        function checkCollision() {
            const map = maps[currentMapKey];
            map.objects.forEach(obj => {
                if(!obj.id || solvedIds.includes(obj.id)) {
                    if (obj.id === 10 && solvedIds.includes(10)) return;
                    return;
                }
                
                let dist = Math.sqrt(Math.pow(player.x - obj.x, 2) + Math.pow(player.y - obj.y, 2));
                if(dist < 5) {
                    handleInteraction(obj.id);
                }
            });
        }
        
        function handleInteraction(id) {
            if (isLocked(id)) {
                showSystemMsg("ğŸ”’ é€™è£¡é–ä½äº†ï¼", "è«‹å…ˆå»è§£é–‹å…¶ä»–çš„è¬é¡Œï¼Œæ‰èƒ½é–‹å•Ÿé€™è£¡ï¼");
                bouncePlayer(); 
                return;
            }
            openDialog(id);
        }

        function bouncePlayer() {
            player.y += 5;
            player.el.style.top = player.y + "%";
        }

        function openDialog(id) {
            keys = {};
            moveDirection = null; 
            activeObj = id;
            const q = randomizedQuestions[id];
            
            const box = document.getElementById('dialog-box');
            document.getElementById('dialog-title').innerText = (q.type === 'end') ? "æœ€çµ‚è©¦ç…‰ï¼" : "ç™¼ç¾è¬é¡Œï¼";
            document.getElementById('dialog-content').innerHTML = q.q;
            document.getElementById('ans-input').value = "";
            if(q.a.toLowerCase() === "ok") {
                document.getElementById('dialog-input-area').style.display = 'none';
                const msgBtn = document.getElementById('dialog-msg-only');
                msgBtn.style.display = 'block';
                msgBtn.onclick = function() { checkAnswer(true); };
            } else {
                document.getElementById('dialog-input-area').style.display = 'block';
                document.getElementById('dialog-msg-only').style.display = 'none';
                document.getElementById('ans-input').focus();
            }
            box.style.display = 'block';
        }

        function showSystemMsg(title, msg) {
            const box = document.getElementById('dialog-box');
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('dialog-content').innerText = msg;
            document.getElementById('dialog-input-area').style.display = 'none';
            
            const msgBtn = document.getElementById('dialog-msg-only');
            msgBtn.style.display = 'block';
            msgBtn.onclick = closeDialog;
            box.style.display = 'block';
        }

        function updateObjectLockStatus() {
            const map = maps[currentMapKey];
            map.objects.forEach(obj => {
                const el = document.getElementById(`obj-${obj.id}`);
                if (!obj.id || solvedIds.includes(obj.id) && obj.type !== 'end') {
                    if (el) el.style.display = 'none'; 
                    return;
                }
                
                if (el) {
                    if (!isLocked(obj.id)) {
                        el.classList.remove('obj-locked'); 
                    }
                }
            });
        }

        function checkAnswer(isAutoPass) {
            const q = randomizedQuestions[activeObj];
            let val = document.getElementById('ans-input').value.trim();
            
            if (isAutoPass || val.toLowerCase() === q.a.toLowerCase()) {
                playAudio('sfx-correct');
                solvedIds.push(activeObj); 
                closeDialog();
                
                document.getElementById('score').innerText = solvedIds.length + "/" + totalQuestionCount;
                
                if (q.type === 'end') {
                    const finalObjEl = document.getElementById(`obj-${activeObj}`);
                    if (finalObjEl) {
                        finalObjEl.classList.remove(`sprite-${q.qType}`); 
                        finalObjEl.classList.add('sprite-princess'); 
                        finalObjEl.classList.remove('quest-box'); 
                        finalObjEl.innerText = "";
                        finalObjEl.style.filter = 'none'; 
                    }
                    setTimeout(() => {
                        alert("æ­å–œï¼éŠæˆ²å…¨ç ´ï¼");
                        location.reload(); 
                    }, 500); 
                } else {
                    let objEl = document.getElementById(`obj-${activeObj}`);
                    if(objEl) objEl.style.display = 'none';
                    updateObjectLockStatus();
                }

                if(q.nextMap) {
                    loadMap(q.nextMap);
                }

            } else {
                playAudio('sfx-wrong');
                alert("ç­”æ¡ˆä¸å°å–”ï¼å†è©¦ä¸€æ¬¡ã€‚");
            }
        }

        function closeDialog() {
            document.getElementById('dialog-box').style.display = 'none';
            bouncePlayer();
        }

        function playAudio(id) {
            const audio = document.getElementById(id);
            if(audio && audio.src) { audio.currentTime = 0; audio.play().catch(e=>{}); }
        }

        function move(dir) { moveDirection = dir;
        }
        function stop() { moveDirection = null; }
    </script>
</body>
</html>